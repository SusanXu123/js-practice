<html>
<body>
    <h1 id="name"></h1>
</body>
</html>
<script>
function Dep () {
  this.subs = [];
}

Dep.prototype = {
  addSub: function(sub) {
    this.subs.push(sub);
  },
  notify: function() {
    this.subs.forEach(function(sub) {
      sub.update();
    });
  }
};

function Watcher(vm, exp, cb) {
    this.cb = cb;
    this.vm = vm;
    this.exp = exp;
    this.value = this.get();  // 将自己添加到订阅器的操作
}

Watcher.prototype = {
    update: function() {
        this.run();
    },
    run: function() {
        var value = this.vm.data[this.exp];
        var oldVal = this.value;
        if (value !== oldVal) {
            this.value = value;
            this.cb.call(this.vm, value, oldVal);
        }
    },
    get: function() {
        Dep.target = this;  // 缓存自己
        var value = this.vm.data[this.exp]
        // 强制执行监听器里的get函数
        // debugger
        Dep.target = null;  // 释放自己
        // debugger
        return value;
    }
};

function defineReactive(data, key, val) {
  observe(val); // 递归遍历所有子属性
  var dep = new Dep();
  Object.defineProperty(data, key, {
    enumerable: true,
    configurable: true,
    get: function() {
      if (Dep.target) {
        // 判断是否需要添加订阅者
        dep.addSub(Dep.target); // 在这里添加一个订阅者
      }
      console.log('dep in get ===', dep);
      return val;
    },
    set: function(newVal) {
      if (val === newVal) {
        return;
      }
      val = newVal;
      console.log('属性' + key + '已经被监听了，现在值为：“' + newVal.toString() + '”');
      dep.notify(); // 如果数据变化，通知所有订阅者
      console.log('dep in set ===', dep);
    }
  });
}
function observe(data) {
    if (!data || typeof data !== 'object') {
        return;
    }
    Object.keys(data).forEach(function(key) {
        console.log(data);
        defineReactive(data, key, data[key]);
    });
};

function SelfVue (data, el, exp) {
    var self = this;
    this.data = data;

    Object.keys(data).forEach(function(key) {
        self.proxyKeys(key);  // 绑定代理属性
    });
    // debugger
    observe(data);
    el.innerHTML = this.data[exp];  // 初始化模板数据的值
    new Watcher(this, exp, function (value) {
        el.innerHTML = value;
    });
    return this;
}

SelfVue.prototype = {
  proxyKeys: function (key) {
    var self = this;
    Object.defineProperty(this, key, {
      enumerable: false,
      configurable: true,
      get: function proxyGetter() {
          return self.data[key];
      },
      set: function proxySetter(newVal) {
          self.data[key] = newVal;
      }
    });
  }
}
</script>
<script>
function nodeToFragment (el) {
  var fragment = document.createDocumentFragment();
  var child = el.firstChild;
  while (child) {
    // 将Dom元素移入fragment中
    fragment.appendChild(child);
    child = el.firstChild
  }
  return fragment;
}
</script>
<script>

var ele = document.querySelector('#name');
const data = {name: 'hello world'}
 var selfVue = new SelfVue(data, ele, 'name');
 window.setTimeout(function () {
     console.log('name值改变了');
     selfVue.name = 'canfoo';
 }, 2000);
</script>
